{% extends "master.html.twig" %}
{% block addHead %}
<style>

.sidemenu {
	height: 100vh;
	width: 0;
	position: fixed;
	background-color: white;
	transition: 0.4s;
	overflow-y: scroll;
}

.sideMenuImage {
	width: 90%;
	padding-top: 60px;
	display: block;
	margin-left: auto;
	margin-right: auto;
}

.propertyCard {
	margin: 10px;
	border: 2px solid black;
	height: 200px;
}

.smImage {
	height: 130px;
}

</style>
<script>

	var sortOrder = "createdTS_DESC";
	var minPrice = "0";
	var maxPrice = "1000000000";
	var beds = ">=0";
	var baths = ">=0";
	var keyword = "";

	var markers = [];
	var propertyList = [];

    let map;

    function initMap() {
		map = new google.maps.Map(document.getElementById("map"), {
			center: { lat: 45.5017, lng: -73.5673 },
			zoom: 12,
		});
    }

	function openSM() {
		document.getElementById("mySidemenu").style.width = "18%";
		document.getElementById("map").style.width = "82%";
	}

	function closeSM() {
		document.getElementById("mySidemenu").style.width = "0";
		document.getElementById("map").style.width = "100%";
	}

	function loadPropList() {
		for (var i = 0; i < propertyList.length; i++) {
			var id = propertyList[i].id;
			var fileName = propertyList[i].photoFilePath;
			var price = propertyList[i].price;
			var streetAddress = propertyList[i].streetAddress;
			var city = propertyList[i].city;
			var province = propertyList[i].province;
			var bedrooms = propertyList[i].bedrooms;
			var bathrooms = propertyList[i].bathrooms;
			$("#mySidemenu").append(`
				<a href="/properties/${id}">
					<div class="propertyCard">
						<img class="smImage" src="../uploads/${id}/thmb-${fileName}" style="height: 130px;">
						<div class="smPrice">$${price}</div>
						<div class="smFullAddress">
						<span class="smStreetAddress">${streetAddress}, </span><span class="smCity">${city}, </span><span class="smProvince">${province}</span>
						</div>
						<div class="smBedBath">
						<span class="smBedrooms">${bedrooms}</span>&nbsp;<i class="fas fa-bed"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span class="smBathrooms">${bathrooms}</span>&nbsp;<i class="fas fa-bath"></i>
						</div>
					</div>
				</a>
			`);
		}
	}

    $(document).ready(function() {

		var urlSearchParams = new URLSearchParams(window.location.search);
		var params = Object.fromEntries(urlSearchParams.entries());

		minPrice = params.minPrice;
		maxPrice = params.maxPrice;
		beds = params.beds;
		baths = params.baths;
		keyword = params.keyword;

		 $.ajax({
			url: '/ajax/properties/map?sortBy=' + sortOrder + '&minPrice=' + minPrice + '&maxPrice=' + maxPrice + '&beds=' + beds + 
				'&baths=' + baths + '&keyword=' + keyword,
			type: 'GET',
			dataType: 'json',
                error: function(jqxhr, status, errorThrown) {
                    // TODO
                }
            }).done(function(propertyListData) {
				var counter = 0;

				for (var i = 0; i < propertyListData.length; i++) {
					propertyList.push(propertyListData[i]);

						$.ajax({
							url: 'https://maps.googleapis.com/maps/api/geocode/json?address=' + propertyListData[i]['postalCode'] + '&key=AIzaSyCflFmMrn2tJfZDEn8eIokkKldXJlTU19Q',
							type: 'GET'
						}).done(function(geolocationData) {
							if (geolocationData.status === "OK") {
								var lat = geolocationData.results[0].geometry.location.lat;
								var lng = geolocationData.results[0].geometry.location.lng;
								var marker = new google.maps.Marker({
								position: { lat: lat, lng: lng },
								map,
								data: propertyListData[counter], 
								counter: counter
								// ,icon: image, // TODO?: add an image variable with a custom image here
								});
								var id = propertyListData[counter].id;
								var fileName = propertyListData[counter].photoFilePath;
								var price = propertyListData[counter].price;
								var streetAddress = propertyListData[counter].streetAddress;
								var city = propertyListData[counter].city;
								var province = propertyListData[counter].province;
								var bedrooms = propertyListData[counter].bedrooms;
								var bathrooms = propertyListData[counter].bathrooms;
								var contentString = `
									<a href="/properties/${id}">
										<div class="propertyCard">
											<img class="smImage" src="../uploads/${id}/thmb-${fileName}" style="height: 130px;">
											<div class="smPrice">$${price}</div>
											<div class="smFullAddress">
											<span class="smStreetAddress">${streetAddress}, </span><span class="smCity">${city}, </span><span class="smProvince">${province}</span>
											</div>
											<div class="smBedBath">
											<span class="smBedrooms">${bedrooms}</span>&nbsp;<i class="fas fa-bed"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span class="smBathrooms">${bathrooms}</span>&nbsp;<i class="fas fa-bath"></i>
											</div>
										</div>
									</a>
								`;
								var infowindow = new google.maps.InfoWindow({
									content: contentString,
								});

								marker.addListener("click", () => {
									if ($(".sidemenu").css("width") === "0px") {
										openSM();
									} else {
										closeSM();
									}
									infowindow.open({
										anchor: marker,
										map,
										shouldFocus: true,
									});
								});

								markers.push(marker);
								counter++;
							} else {
								return;
							}
						});

				}
				loadPropList();
				initMap();
            });

    });

</script>
{% endblock %}

{% block content %}
	<div id="mySidemenu" class="sidemenu"></div>

    <div id="map" style="height: 100vh; width: 100%; float: right; transition: 0.4s;"></div>

    <script desync
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCflFmMrn2tJfZDEn8eIokkKldXJlTU19Q">
    </script> 
{% endblock %}
